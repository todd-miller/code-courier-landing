name: Courier

on:
  push:
    branches:
      - main

env:
  DESTINATION_REPO: 'todd-miller/code-courier-landing'
  DESTINATION_BRANCH: 'main'


jobs:
  build:
    runs-on: ubuntu-latest    

    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          persist-credentials: false
          fetch-depth: 0
         
      - name: Version Codebase
        id: version
        uses: paulhatch/semantic-version@v5.0.2
        with:
          tag_prefix: 'v'

      - name: Capture Version Name
        id: semver
        run: |
          output="$(${{ steps.version.outputs.major }}.${{ steps.version.outputs.minor }}.${{steps.version.outputs.patch}})"
          # end of optional handling for multi line json
          echo "::set-output name=name::$output"

      - name: Push to Remote
        uses: ad-m/github-push-action@master
        with: 
          force: true
          branch: Release-${{ steps.semver.outputs.name}}
          github_token: ${{ secrets.ACCESS_TOKEN }}
          repository: ${{ env.DESTINATION_REPO }} 

      - name: Open PR 
        uses: repo-sync/pull-request@v2 
        with:
          github_token: ${{ secrets.ACCESS_TOKEN }}
          source_branch: Release-${{ steps.semver.outputs.name}}
          destination_branch: ${{ env.DESTINATION_BRANCH }} 
          destination_repository: ${{ env.DESTINATION_REPO }} 
          pr_title: "Release-${{ steps.version.outputs.major }}"
          pr_body: |
            :crown: *An automated PR*
            
            # Things Accomplished:
            Automated PR Creation in Public Remote Repository
            
            v${{ steps.version.outputs.major}}.${{ steps.version.outputs.minor}}.${{ steps.version.outputs.patch}}
            
            # Next Things to Test
            - are Major Versions tracked without dropped a Tagged Version?
            - how best should this Occur?
            - I think I need to tag releases so i can increment accordingly
            - not sure if I'm stuck? 

          pr_label: 'release'
          
     
      - name: output-url
        run: echo ${{steps.open-pr.outputs.pr_url}}
      - name: output-number
        run: echo ${{steps.open-pr.outputs.pr_number}}
      - name: output-created
        run: echo ${{steps.open-pr.outputs.pr_created}}
      - name: output-has-changed-files 
        run: echo ${{steps.open-pr.outputs.has_changed_files}}
